# 微信小程序手机号授权登录配置指南

## 📱 功能说明

小程序"我的"页面支持微信手机号快捷登录功能，用户点击头像区域后会弹出微信授权页面，授权后可获取用户手机号并实现登录。

## 🔧 配置步骤

### 1. 获取微信小程序凭证

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入你的小程序管理后台
3. 在 **开发 > 开发管理 > 开发设置** 中找到：
   - **AppID (小程序ID)**
   - **AppSecret (小程序密钥)** - 点击"生成"或"重置"获取

### 2. 配置后端环境变量

在 `backend` 目录下创建 `.env` 文件（如果不存在），添加以下配置：

```env
# 数据库配置
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=
DB_NAME=medical_points

# 服务器配置
PORT=4000

# 微信小程序配置（必填）
WECHAT_APPID=你的小程序AppID
WECHAT_APP_SECRET=你的小程序AppSecret
```

### 3. 安装依赖

确保后端已安装 `axios` 依赖：

```bash
cd backend
npm install axios
```

### 4. 配置小程序权限

在微信公众平台中：

1. 进入 **开发 > 接口设置**
2. 找到 **手机号快速验证组件**
3. 确保该功能已开通（企业认证的小程序才能使用）

### 5. 配置服务器域名

在微信公众平台中：

1. 进入 **开发 > 开发管理 > 开发设置 > 服务器域名**
2. 在 **request合法域名** 中添加你的后端服务器域名
   - 开发环境：可以在微信开发者工具中勾选"不校验合法域名"
   - 生产环境：必须配置 HTTPS 域名

## 🎯 使用流程

### 用户端操作

1. 打开小程序，进入"我的"页面
2. 点击用户头像区域
3. 在弹出的授权页面点击"允许"
4. 系统自动获取手机号并完成登录
5. 登录信息会保存在本地，下次自动登录

### 技术流程

```
用户点击授权
    ↓
微信弹出授权页面
    ↓
用户同意授权
    ↓
小程序获取 code
    ↓
发送到后端 /api/decrypt-phone
    ↓
后端调用微信API获取 access_token
    ↓
后端调用微信API解密手机号
    ↓
返回手机号给小程序
    ↓
小程序保存手机号到本地
    ↓
显示登录成功
```

## 📝 API 接口说明

### POST /api/decrypt-phone

解密微信手机号

**请求参数：**
```json
{
  "code": "微信返回的code"
}
```

**成功响应：**
```json
{
  "success": true,
  "phoneNumber": "13800138000",
  "countryCode": "86"
}
```

**失败响应：**
```json
{
  "success": false,
  "message": "错误信息",
  "error": "详细错误"
}
```

## ⚠️ 注意事项

### 1. 企业认证要求
- 手机号快速验证功能需要小程序完成**企业认证**
- 个人小程序无法使用此功能
- 如果是个人小程序，建议使用微信登录获取用户信息

### 2. 安全性
- AppSecret 是敏感信息，不要提交到代码仓库
- 使用 `.env` 文件管理敏感配置
- `.env` 文件已在 `.gitignore` 中排除

### 3. 开发调试
- 在微信开发者工具中测试时，需要勾选"不校验合法域名"
- 真机调试时，需要配置合法的服务器域名
- code 只能使用一次，重复使用会报错

### 4. 错误处理
常见错误及解决方案：

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| code is required | 未传递code参数 | 检查小程序端是否正确获取code |
| Missing WeChat credentials | 未配置AppID或AppSecret | 检查.env文件配置 |
| Failed to get access token | AppID或AppSecret错误 | 检查配置是否正确 |
| Failed to decrypt phone number | code无效或已使用 | 重新获取code |
| 40001 | AppSecret错误 | 检查AppSecret是否正确 |
| 40013 | AppID无效 | 检查AppID是否正确 |

## 🔄 退出登录

用户可以通过以下方式退出登录：

1. 点击已登录的用户信息区域
2. 在弹出菜单中选择"退出登录"
3. 确认后清除本地登录信息

## 📦 相关文件

- **小程序端：**
  - `pages/profile/index.wxml` - 页面结构
  - `pages/profile/index.js` - 登录逻辑
  - `pages/profile/index.wxss` - 页面样式
  - `app.js` - 全局数据管理

- **后端：**
  - `backend/server.js` - 手机号解密API
  - `backend/.env` - 环境变量配置

## 🚀 快速测试

1. 启动后端服务：
```bash
cd backend
npm start
```

2. 打开微信开发者工具
3. 导入小程序项目
4. 在"我的"页面点击头像测试授权

## 📞 技术支持

如遇到问题，请检查：
1. 后端服务是否正常运行
2. .env 配置是否正确
3. 小程序是否完成企业认证
4. 控制台是否有错误日志
